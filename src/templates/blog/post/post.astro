---
import { getPage } from '@/lib/cms';
import translate from '@/lib/translate';
import { fetchTranslations } from '@/lib/api';
import { getLocaleFromPathname } from '@/lib/pathname-utils';

import Layout from '@/components/Layout/Layout.astro';

import InnerAsideLayout from '@/components/InnerAsideLayout.astro';
// import AsideServices from '../../service/components/AsideServices.astro';
import AsideFeaturedPosts from './components/AsideFeaturedPosts.astro';
import AsideRecentPosts from './components/AsideRecentPosts.astro';
import PostInfo from './components/PostInfo.astro';
import LastUpdated from './components/LastUpdated.astro';

export interface Props {
  post: Post;
}

const {
  locale,
  to, // TODO:

  title,
  metaTitle,
  headline,
  metaDescription,
  cover,
  noindex,
  nofollow,
  datePublished,
  dateModified,
  readingTime,
  html,
  authors,
} = Astro.props.post;

/* <AsideServices mainNav={mainNav} /> */
const translations = fetchTranslations(locale);
const t: ITranslationFunc = function (key: string, params?: Record<string, string>): string {
  return translate(key, translations, params);
};


const [indexPage] = Astro.fetchContent('../../../../content/blog/pages/blog/blog.??.md').filter((p) => getLocaleFromPathname(p.file.pathname) === locale).map(getPage);

const  breadcrumbs = {
  lastItemTitle: title,
  items: [{ to: indexPage?.to, title: indexPage?.title }],
};

const seo = {
  title: metaTitle,
  description: metaDescription,
  noindex,
  nofollow,

  locale,
  headline,
  to,

  breadcrumbs,
  datePublished,
  dateModified,
  authors,
  pageType: 'BlogPosting',
  imgPath: cover?.sm?.publicURL, // TODO:
};
---
<Layout {seo} {title} {headline} {breadcrumbs}>
  <PostInfo {authors} {datePublished} {readingTime} {t} />
  <InnerAsideLayout {cover} {html}>
    <aside slot="aside" class="flex flex-col">
      <AsideRecentPosts t={t} />
      <AsideFeaturedPosts t={t} />
    </aside>
  </InnerAsideLayout>
  {dateModified && ((datePublished && dateModified !== datePublished) || !datePublished) ? <LastUpdated {dateModified} {t} /> : null}
</Layout>
