---
import i18n from '../../../config/i18n';
import { getLocaleFromPathname } from '../../../lib/getPostInfo';
import PostList from './components/PostList.astro';
import { fetchAuthors } from '../../../lib/api';

const locale = Astro.request.params.locale || i18n.defaultLocale;

const [page] = Astro.fetchContent('../../../../content/blog/pages/blog/blog.??.md')?.filter((p) => getLocaleFromPathname(p.file.pathname, true) === locale);

// TODO: sort: { fields: [featured, datePublished], order: [ASC, DESC] }
const posts = Astro.fetchContent('../../../../content/blog/posts/*/*.??.md')?.filter((p) => getLocaleFromPathname(p.file.pathname, true) === locale);

const authors = fetchAuthors(locale);
posts.forEach((p) => {
  if (p.author && Array.isArray(p.author)) {
    p.author = p.author.map((key) => {
      const a = authors.find((el) => el.email === key);
      if (a) {
        return a;
      }
      return {};
    });
  }
});

---
<PostList page={page} posts={posts} />
